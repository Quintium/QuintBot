#pragma once

#include <iostream>
#include <fstream>
#include "Board.h"

// class for a node in the game
class Node
{
	std::string move;
	int games;
	std::vector<Node> nodes;

public:
	Node(std::string data)
	{
		// strip off "{" and "}"
		data = data.substr(1, data.size() - 1);

		// find the first comma and set the move to the text before it
		size_t comma = data.find(",");
		move = data.substr(0, comma);

		// find the second comma and set the games to the text before it
		size_t comma2 = data.find(",", comma + 1);
		games = std::stoi(data.substr(comma + 1, comma2));

		// loop through the list of objects
		size_t objectStart = comma2 + 2;
		while (data[objectStart] != ']')
		{
			// find the end of the object
			size_t objectEnd = objectStart + 1;
			int openBraces = 1;
			while (openBraces > 0)
			{
				if (data[objectEnd] == '{')
				{
					openBraces++;
				}
				else if (data[objectEnd] == '}')
				{
					openBraces--;
				}
				objectEnd++;
			}

			// create a node with that object string and add it to the nodes
			
			nodes.push_back(Node(data.substr(objectStart, objectEnd)));

			objectStart = objectEnd + 1;
		}
	}

	// get node after moves
	std::optional<Node> getNode(std::vector<Move> moves)
	{
		if (nodes.size() == 0)
		{
			return std::optional<Node>();
		}

		if (moves.size() == 0)
		{
			return *this;
		}

		for (Node node : nodes)
		{
			if (node.move == moves[0].getNotation())
			{
				moves.erase(moves.begin());
				return node.getNode(moves);
			}
		}

		return std::optional<Node>();
	}

	std::string randomMove()
	{
		unsigned int seed = (unsigned int)std::chrono::system_clock::now().time_since_epoch().count();
		std::mt19937 generator(seed);
		std::uniform_real_distribution<double> distribution(0, 1);
		double random = distribution(generator);

		int sum = 0;
		for (Node node : nodes)
		{
			sum += node.games;
		}

		double subtotal = 0;
		for (Node node : nodes)
		{
			subtotal += ((double)node.games) / sum;
			if (subtotal >= random)
			{
				return node.move;
			}
		}

		return nodes[nodes.size() - 1].move;
	}
};

class Openings : public Node
{
public:
	Openings(std::string data) : Node(data)
	{
	}

	// load openings from file
	static Openings loadOpenings()
	{
		// opening database string
		std::string data = "{,300000,[{e2e4,163298,[{e7e5,49934,[{f2f4,5364,[{b8c6,853,[{g1f3,737,[{d7d6,276,[{f1c4,140,[]},]},{f8c5,99,[]},{e5f4,191,[]},]},]},{e5f4,2566,[{g1f3,2264,[{d7d6,339,[{f1c4,198,[]},{d2d4,122,[]},]},{g7g5,556,[{f1c4,345,[{g5g4,104,[]},]},{h2h4,110,[{g5g4,91,[]},]},]},{f8e7,351,[{f1c4,227,[{e7h4,166,[{e1f1,95,[]},]},]},]},{d7d5,276,[{e4d5,191,[]},]},]},]},{d7d5,768,[{e4d5,539,[{e5e4,231,[{d2d3,92,[]},]},{e5f4,180,[{g1f3,140,[]},]},]},{g1f3,122,[]},]},{d7d6,643,[{g1f3,544,[{c8g4,129,[]},{b8c6,206,[{f1c4,129,[]},]},{e5f4,100,[]},]},]},]},{g1f3,31549,[{b8c6,20877,[{f1c4,8131,[{g8f6,2694,[{f3g5,819,[{f8c5,136,[]},{d7d5,666,[{e4d5,657,[{c6a5,395,[]},{f6d5,130,[]},]},]},]},{b1c3,389,[{f8c5,168,[]},]},{d2d3,803,[{f8c5,389,[{c2c3,97,[]},{e1g1,112,[]},]},{f8e7,205,[]},]},{d2d4,272,[{e5d4,209,[]},]},{e1g1,342,[{f8c5,171,[]},]},]},{f8c5,3016,[{c2c3,827,[{g8f6,492,[{d2d4,273,[{e5d4,267,[]},]},{d2d3,134,[]},]},{d7d6,220,[{d2d4,141,[{e5d4,140,[]},]},]},]},{e1g1,856,[{d7d6,259,[{c2c3,134,[]},]},{g8f6,528,[{d2d3,163,[]},{c2c3,110,[]},{d2d4,97,[]},]},]},{b2b4,343,[{c5b4,254,[{c2c3,253,[{b4a5,105,[]},]},]},]},{d2d3,463,[{h7h6,118,[]},{g8f6,200,[]},{d7d6,119,[]},]},{b1c3,305,[{g8f6,198,[{d2d3,123,[]},]},]},]},{h7h6,864,[{c2c3,136,[]},{e1g1,217,[{g8f6,138,[]},]},{d2d4,220,[{e5d4,165,[{f3d4,136,[]},]},]},{b1c3,174,[{g8f6,92,[]},]},]},]},{d2d4,3798,[{e5d4,3384,[{f3d4,2288,[{f8c5,783,[{d4c6,292,[{b7c6,159,[]},{d8f6,122,[]},]},{c1e3,343,[{d8f6,172,[]},]},]},{c6d4,624,[{d1d4,623,[{c7c5,100,[]},{d7d6,229,[]},]},]},{g8f6,372,[{b1c3,131,[{f8b4,95,[]},]},{d4c6,210,[{b7c6,198,[]},]},]},]},{f1c4,864,[{d7d6,99,[]},{g8f6,269,[{e1g1,98,[]},{e4e5,126,[]},]},{f8c5,229,[{c2c3,168,[]},]},]},]},]},{f1b5,6562,[{a7a6,2473,[{b5a4,1740,[{g8f6,1207,[{e1g1,810,[{f8e7,377,[]},{b7b5,268,[]},]},{d2d3,239,[{b7b5,139,[]},]},]},{b7b5,328,[{a4b3,325,[{g8f6,107,[]},]},]},]},{b5c6,713,[{d7c6,656,[{d2d4,96,[]},{e1g1,306,[{f8d6,93,[]},{c8g4,121,[]},]},]},]},]},{d7d6,1232,[{d2d4,411,[{c8d7,105,[]},{e5d4,219,[{f3d4,166,[{c8d7,161,[]},]},]},]},{e1g1,288,[{c8d7,117,[]},]},{b5c6,213,[{b7c6,213,[]},]},]},{g8f6,959,[{e1g1,480,[{d7d6,126,[]},{f8c5,105,[]},{f6e4,152,[]},]},{d2d3,214,[]},{b5c6,130,[{d7c6,108,[]},]},]},{f8c5,666,[{b5c6,123,[{d7c6,98,[]},]},{c2c3,157,[]},{e1g1,319,[{d7d6,115,[]},]},]},]},]},{d7d6,5810,[{f1c4,2515,[{f8e7,609,[{d2d4,145,[{e5d4,118,[]},]},{b1c3,107,[]},{e1g1,134,[{g8f6,116,[]},]},]},{h7h6,559,[{e1g1,104,[]},{d2d4,146,[{e5d4,114,[]},]},{b1c3,113,[]},]},{c8g4,399,[{h2h3,130,[]},]},]},{d2d4,2181,[{e5d4,1327,[{f3d4,1033,[{g8f6,384,[{b1c3,302,[{f8e7,211,[]},]},]},{f8e7,175,[{b1c3,104,[]},]},{c7c5,124,[]},]},{d1d4,180,[]},]},{c8g4,274,[{d4e5,196,[{g4f3,155,[{d1f3,121,[{d6e5,120,[]},]},]},]},]},]},]},]},]},{c7c5,39551,[{g1f3,22161,[{d7d6,7921,[{d2d4,4889,[{c5d4,4775,[{f3d4,4270,[{g8f6,3571,[{b1c3,3188,[{g7g6,741,[]},{a7a6,1987,[]},]},]},]},]},]},{f1c4,862,[{e7e6,315,[{e1g1,93,[]},]},{g8f6,261,[{d2d3,100,[]},]},{b8c6,192,[]},]},]},{e7e6,4192,[{d2d4,2497,[{c5d4,2208,[{f3d4,2035,[{g8f6,459,[{b1c3,340,[{f8b4,123,[]},{b8c6,122,[]},]},]},{a7a6,872,[{b1c3,470,[{d8c7,285,[]},]},{c2c4,151,[]},]},{b8c6,495,[{b1c3,250,[]},]},]},]},]},{c2c3,458,[{d7d5,159,[{e4d5,105,[]},]},{g8f6,98,[]},]},]},{b8c6,8154,[{f1b5,1083,[{g7g6,204,[{b5c6,99,[]},]},{e7e6,177,[{b5c6,101,[{b7c6,93,[]},]},]},{d7d6,246,[{b5c6,97,[{b7c6,96,[]},]},]},{c6d4,115,[{f3d4,104,[{c5d4,103,[]},]},]},{a7a6,141,[{b5c6,136,[{b7c6,97,[]},]},]},]},{d2d4,4340,[{c5d4,4121,[{f3d4,3907,[{g7g6,692,[{b1c3,337,[{f8g7,328,[]},]},{d4c6,121,[{b7c6,117,[]},]},{c2c4,97,[]},]},{e7e5,1080,[{d4b5,489,[{d7d6,279,[]},{a7a6,143,[]},]},{d4c6,280,[{b7c6,271,[]},]},{d4b3,147,[]},]},{g8f6,858,[{b1c3,724,[{e7e6,137,[]},{e7e5,337,[]},{d7d6,126,[]},]},{d4c6,99,[{b7c6,97,[]},]},]},{e7e6,437,[{b1c3,210,[]},]},{d7d6,408,[{b1c3,235,[]},]},]},]},]},{f1c4,932,[{d7d6,123,[]},{e7e6,596,[{d2d4,116,[]},{b1c3,106,[]},{e1g1,146,[]},{c2c3,103,[]},]},{g7g6,106,[]},]},]},]},]},{e7e6,22098,[{d2d4,11606,[{d7d5,8787,[{e4d5,2442,[{e6d5,2309,[{g1f3,822,[{f8d6,175,[{f1d3,98,[]},]},{g8f6,396,[{f1d3,185,[]},]},]},{c2c4,468,[{g8f6,235,[{b1c3,136,[]},]},{c7c6,97,[]},]},{b1c3,315,[{g8f6,175,[]},]},{f1d3,461,[{g8f6,234,[{g1f3,114,[]},]},{f8d6,99,[]},]},]},]},{e4e5,2295,[{c7c5,2077,[{c2c3,1526,[{b8c6,1072,[{g1f3,805,[{c8d7,189,[]},{d8b6,397,[]},]},]},{d8b6,230,[{g1f3,159,[{b8c6,120,[]},]},]},]},{g1f3,262,[{b8c6,147,[]},]},]},]},{b1d2,1391,[{c7c5,323,[{e4d5,130,[]},{c2c3,98,[]},]},{d5e4,300,[{d2e4,298,[{b8d7,106,[]},{g8f6,97,[]},]},]},{g8f6,554,[{e4e5,481,[{f6d7,453,[{f1d3,230,[{c7c5,217,[]},]},]},]},]},]},{b1c3,2408,[{g8f6,837,[{e4e5,402,[{f6d7,385,[{f2f4,228,[{c7c5,196,[]},]},]},]},{c1g5,358,[{f8e7,239,[{e4e5,188,[{f6d7,170,[]},]},]},]},]},{f8b4,741,[{e4d5,115,[{e6d5,93,[]},]},{e4e5,420,[{c7c5,313,[{a2a3,220,[{b4c3,155,[]},]},]},]},]},{d5e4,492,[{c3e4,467,[{g8f6,164,[]},{b8d7,132,[{g1f3,91,[]},]},]},]},]},]},]},{g1f3,4763,[{d7d5,3063,[{e4e5,602,[{c7c5,525,[{d2d4,175,[{b8c6,106,[]},]},{c2c3,132,[{b8c6,100,[]},]},{b2b4,131,[]},]},]},{e4d5,2064,[{e6d5,1986,[{d2d4,1599,[{g8f6,799,[{b1c3,152,[]},{f1d3,229,[{f8d6,111,[]},]},{c2c4,114,[]},]},{c7c6,174,[]},{f8d6,253,[]},]},]},]},]},]},]},]},{d2d4,81285,[{e7e6,8769,[{c2c4,3939,[{d7d5,1693,[{b1c3,1088,[{c7c6,146,[]},{g8f6,527,[{g1f3,163,[]},{c4d5,106,[]},{c1g5,135,[{f8e7,92,[]},]},]},{d5c4,172,[]},]},{g1f3,254,[{g8f6,141,[]},]},]},{g8f6,465,[{b1c3,308,[{f8b4,154,[]},]},]},{c7c5,400,[{d4d5,187,[]},]},]},{e2e4,905,[{d7d5,477,[{e4e5,203,[{c7c5,168,[{c2c3,109,[]},]},]},{e4d5,108,[{e6d5,93,[]},]},{b1c3,103,[]},]},{c7c5,105,[]},]},{g1f3,1776,[{g8f6,203,[]},{d7d5,794,[{e2e3,152,[]},{c2c4,123,[]},{c1g5,151,[]},{c1f4,168,[]},]},{c7c5,195,[]},]},]},{g8f6,21689,[{c2c4,10863,[{c7c5,1497,[{e2e3,154,[]},{b1c3,216,[{c5d4,187,[{d1d4,173,[{b8c6,146,[{d4d1,130,[]},]},]},]},]},{d4d5,890,[{b7b5,533,[{c4b5,310,[{a7a6,303,[{b5a6,155,[{c8a6,100,[]},]},]},]},]},{e7e6,196,[{b1c3,168,[{e6d5,158,[{c4d5,146,[{d7d6,136,[]},]},]},]},]},]},{g1f3,181,[{c5d4,124,[{f3d4,112,[]},]},]},]},{g7g6,3508,[{b1c3,2868,[{f8g7,1944,[{e2e4,1359,[{d7d6,1067,[{f2f4,171,[{e8g8,135,[]},]},{g1f3,345,[{e8g8,310,[]},]},{f2f3,209,[{e8g8,173,[]},]},]},{e8g8,270,[]},]},{g1f3,267,[{d7d6,110,[]},{e8g8,134,[]},]},]},{d7d5,803,[{e2e3,105,[{f8g7,98,[]},]},{g1f3,163,[{f8g7,158,[]},]},{c4d5,358,[{f6d5,358,[{e2e4,292,[{d5c3,285,[]},]},]},]},]},]},]},{e7e6,3474,[{b1c3,2284,[{d7d5,607,[{c1g5,139,[]},{g1f3,161,[]},{c4d5,133,[{e6d5,112,[]},]},{e2e3,102,[]},]},{f8b4,1328,[{c1d2,142,[]},{c1g5,176,[]},{g1f3,227,[]},{d1c2,309,[{e8g8,113,[]},]},{e2e3,219,[]},]},]},{g1f3,682,[{b7b6,163,[]},{f8b4,188,[{c1d2,108,[]},]},{d7d5,218,[{b1c3,98,[]},]},]},]},]},{g1f3,4634,[{g7g6,1685,[{c1f4,349,[{f8g7,305,[{e2e3,217,[{e8g8,123,[]},]},]},]},{g2g3,250,[{f8g7,232,[{f1g2,228,[{e8g8,155,[{e1g1,129,[]},]},]},]},]},{c2c4,384,[{f8g7,317,[{b1c3,270,[{e8g8,117,[]},]},]},]},{c1g5,203,[{f8g7,176,[]},]},{e2e3,186,[{f8g7,168,[]},]},]},{d7d5,708,[{c1f4,165,[]},{c2c4,164,[]},{e2e3,122,[]},{g2g3,93,[]},]},{e7e6,1307,[{c2c4,288,[{d7d5,111,[]},]},{c1f4,281,[{d7d5,112,[{e2e3,91,[]},]},]},{c1g5,228,[]},{g2g3,166,[]},{e2e3,187,[]},]},{c7c5,478,[{c2c3,98,[]},{d4d5,93,[]},{e2e3,108,[]},]},]},]},{d7d5,28594,[{c2c4,14177,[{c7c6,3973,[{b1c3,2309,[{g8f6,1433,[{c1g5,229,[{e7e6,115,[]},]},{e2e3,165,[]},{g1f3,695,[{e7e6,266,[{c1g5,140,[]},]},{d5c4,98,[]},{c8f5,119,[]},]},]},{e7e6,475,[{g1f3,232,[{g8f6,110,[]},]},]},]},{c4d5,429,[{c6d5,386,[{b1c3,269,[{g8f6,149,[]},]},]},]},{g1f3,736,[{g8f6,464,[{b1c3,268,[{e7e6,125,[]},]},]},{e7e6,114,[]},]},]},{d5c4,2404,[{e2e4,366,[]},{e2e3,630,[{g8f6,120,[{f1c4,111,[]},]},{b7b5,127,[{a2a4,111,[]},]},{e7e6,95,[]},]},{g1f3,285,[{g8f6,94,[]},]},{b1c3,1029,[{c7c6,108,[]},{e7e6,220,[{e2e4,120,[]},]},{g8f6,252,[{e2e4,122,[]},]},]},]},{e7e6,4332,[{b1c3,2756,[{g8f6,1633,[{c4d5,300,[{e6d5,219,[{c1g5,187,[{f8e7,92,[]},]},]},]},{g1f3,534,[{f8e7,213,[]},]},{c1g5,491,[{f8e7,297,[{e2e3,175,[]},]},]},]},{c7c6,378,[{g1f3,176,[]},]},]},{g1f3,743,[{c7c6,96,[]},{g8f6,443,[{b1c3,155,[]},{g2g3,111,[]},]},]},]},{g8f6,1627,[{b1c3,861,[{d5c4,125,[]},{e7e6,385,[{g1f3,109,[]},{c1g5,106,[]},]},{c7c6,140,[]},]},{c4d5,368,[{f6d5,267,[{e2e4,186,[{d5f6,100,[]},]},]},]},{g1f3,191,[]},]},]},{g1f3,5523,[{g8f6,1802,[{c2c4,371,[{e7e6,150,[]},{c7c6,128,[]},]},{c1g5,212,[]},{e2e3,355,[{e7e6,104,[]},]},{g2g3,216,[]},{c1f4,436,[{e7e6,151,[{e2e3,132,[]},]},]},]},{c7c6,813,[{e2e3,141,[]},{c2c4,199,[{g8f6,116,[]},]},{g2g3,93,[]},{c1f4,198,[{g8f6,93,[]},]},]},{e7e6,1179,[{c1g5,127,[]},{e2e3,272,[{g8f6,115,[]},]},{c1f4,270,[{g8f6,126,[{e2e3,109,[]},]},]},{c2c4,227,[{g8f6,98,[]},]},]},{b8c6,556,[{e2e3,128,[]},{c1f4,142,[]},{c2c4,100,[]},]},]},]},]},]}";
		return Openings(data);
	}
};